# Cloudera 介绍与配置

## 1. Cloudera 介绍

### 1.1 Cloudera 简单概念

CDH 是一个可用于机器学习，分析，并且针对类似云产品进行大量优化的一个现代化平台。实际上就是可以将维护整个 hadoop 生态圈，只提供一个平台管理页面，即可一键完成部署，启动，关闭，整个集群中的某一个服务。

### 1.2 Cloudera 适用场景

- 数据仓库：
- 数据科学
- 数据工程
- 企业级大数据解决方案

## 2. CDH 介绍

### 2.1 CDH 简单概念

CDH 是一个以 Apache Hadoop 为核心的，成熟稳定的项目，整合了 Hadoop 生态圈。其中包括 Hive，Hbase，Sentry，Impala，Kudu，Spark等

## 3. Cloudera Manager 介绍

### 3.1 Cloudera Manager 简单概念

Cloudera Manager 是一个用于管理 CDH 集群的终端产品。通过 Cloudera Manager 可以非常简单且集中部署 CDH 集群当中的每一个服务。应用会自动安装并配置，节省整个部署和维护时间。同时还提供了 web 操作界面，可以直接配置整个集群信息

### 3.2 Cloudera Manager 中的一些术语介绍

这里只做一些简单介绍，一些术语我自己也不是特别理解，写多了反而容易写错，这里就简单的描述一下自我理解，不一定完全正确

- **deployment** - Cloudera Manager 用于管理集群的配置
- **dynamic resource pool** - 
- **cluster** - 集群，通常来讲是指一群安装部署了 hadoop 的机器，但是在 Cloudera Manager 里，是指安装了 CDH 服务的机器。每一台机器只能属于一个 CDH 集群，但是 Cloudera Manager 可以同时管理多个 CDH 集群
- **host** - 物理机或者虚拟机，一台 host 只能属于一个 CDH 集群
- **rack** - 在 Cloudera Manager 中，指的是物理上，连接在同一台交换机上的服务器
- **service** - 一般是指 CDH 集群中的服务，比如 Spark 服务，Hive 服务，Impala 服务等
- **service instance** - 服务实例
- **role** - 角色，一般是指服务内的角色，比如对于 hadoop 服务内，有两个角色，一个是 namenode 角色，一个是 datanode 角色
- **role instance** - 角色实例，可以想像成运行该角色的进程
- **host template** - 
- **gateway** - 一种角色类型，一般是用来提供对外服务。一般来讲，像 Hive，Hadoop，Spark 这些服务都会有自己的对外服务接口，方便外部客户端调用。而 gateway 可以想成将这些所有对外接口整合在一起，统一管理，部署有 gateway 的服务器，一般称呼为 gateway node
- **parcel** - 一些以二进制格式分布式存储的文件，一般保存着编译过的代码，包的版本，描述，依赖等元信息
- **static service pool** - Cloudera Manager 管理的整个集群当中的 CPU，内存，I/O 等信息

### 3.3 Cloudera Manager 基本结构组织

如下图所示，整个 Cloudera Manager 的核心是 Cloudera Manager Server，该 Server 提供了对外的 Admin Console Web 服务。同时还负责 Hadoop 生态圈中的其它服务的安装，配置，启动和关闭等

![avatar](cloudera-manager.png)

具体组件介绍：

- Agent：在集群当中的每台 host 上都有安装，该服务负责在每台机器中启动关闭进程(其它服务进程)，解压配置，触发安装，并且监控当前 host 的运行状态
- Management Service：由许多不同角色组成的一个服务，用于提供监视，报警服务
- Database：保存配置，监控信息。通常来讲，逻辑上的数据库是运行在不同的数据库服务器上的。
- Cloudera Repository：存储 Cloudera Manager 用于分发到各个 host 上所需要的包
- Clients：对外提供服务
  1. Admin Console：Cloudera Manager 提供的web端管理服务
  2. API：开发人员可以通过 API 建立定制版的 Cloudera Manager 应用

默认情况下，Agent 服务每 15s 就会向 Cloudera Manager Server 发送一次心跳检查

### 3.4 State Management

Cloudera Manager 会维护所有 cluster 的 state。state 可以被分为两个大类：model 和 runtime。二者都会保存在 Cloudera Manager Server Database 里。

Models 是指每个服务里的角色，配置，依赖信息等，定义哪些机器跑哪些服务的哪些角色

Runtime State 是指具体有哪些命令正在执行

### 3.5 Configuration Management

Cloudera Manager 针对配置定义了多个级别：

- **The Service Level** - Service Level 级别的配置主要应用与服务实例上，比如 HDFS 的 replication 配置（dfs.replication）
- **The role group level** - 该配置主要应用于服务中的具体角色实例上，比如 HDFS 服务中的 DataNode 角色，可以单独配置 handler count (dfs.datanode.handler.count)
- role group level 的配置会覆盖从 Service level 继承下来的相同配置，所以配置的时候要注意这一点
- hosts 会拥有一些与环境有关的配置，比如监视器配置等
- Cloudera Manager 自己本身的配置的管理与维护由自己本身提供，不在此处

### 3.6 Process Management

在非 Cloudera Manager 环境下，启动一个服务一般使用服务自己的启动脚本，或者使用系统配置好的脚本，比如 service hadoop-hdfs-datanode start，但是在 Cloudera Manager 环境下，该命令是不起作用的。

用户只能通过 Cloudera Manager 来启动和关闭服务。Cloudera Manager 使用开源的 Process Management 服务：supervisord。该服务负责启动关闭进程，监控输出日志，报告错误等。同时针对失败的进程 Cloudera Manager 也会尝试重新启动

停止 Cloudera Manager Server 和 Cloudera Manager Client 服务并不会关闭正在跑的其它服务，其它正在运行的进程将继续运行下去。

Cloudera Manager Agent 服务是通过 init.d 启动的，当它启动之后，就会去与 Cloudera Manager 进行联系，然后来决定接下来需要启动哪些服务。Agent 服务也会被 Cloudera Mangager Monitor 进行监视，一旦 Agent 服务挂掉，那么当前这台 host 会被标记为非健康状态。

Agent 负责启动和关闭新的进程，通过与 Cloudera Manager Client 的 heartbeat 沟通，一旦获取到了新的 process 启动请求，agent 会创建本地目录 /var/run/cloudera-scm-agent 并且解压获取到的配置信息，然后通知 supervisord 服务去启动新的进程

### 3.7 Software Distribution Management

Cloudera Manager 最主要的任务就是安装和升级 CDH 集群当中的服务。Cloudera Manager 支持两种软件分发格式(software distribution formats)：packages 和 percels

Packages（包） 是一个二进制包，包含了已经编译好的代码，和一些包的版本，依赖等信息。Package Management System 会评估这些信息，并允许这些包自行查找和升级到最新的版本，并且会自动下载完整依赖。Cloudera Manager 一般使用本地自带的包管理系统(native system package manager)，各个系统有各自不同的包管理工具。（比如 yum 和 apt-get）

Parcel 也是一个二进制分发格式，但是会多保存一些元信息用于 Cloudera Manager 管理

二者具体区别：

- Parcel 是独立安装到版本目录下的，意味着可以在一台机器上安装多个不同版本的 Parcel，在使用的时候会指定使用版本即可。当然在安装包的时候，同一时间只会有一个包被安装，所以无需担心具体是哪个包被安装了，哪个被激活了
- Parcel 支持滚动升级（rolling upgrade），在升级的时候，不会打断整体服务，整个服务会分别升级
- 你可以将 Parcel 安装在系统里的任意目录下，默认安装目录为 /opt/cloudera/parcels，与之相对的，package 服务默认安装在 /usr/lib 目录下
- 如果你从 Parcel 页面安装 Parcel 服务，Cloudera Manager 会自动下载，分发，然后激活正确 parcel。逻辑上属于同一个集群的 host 必须拥有相同的操作系统

基于上述特性，Parcels 相比 Packages 拥有如下优点：

- **Distribution of CDH as a single object** - 大概意思应该是，只需要下载一次，然后将这一个包分发到集群里的机器上，即使有些机器不能联网也能升级。而 packages 虽然每台机器都有安装，但都要下载升级包
- **Internal consistency** - 所有 CDH 组件都是版本匹配的，不会下载到不同 CDH 版本里的组件。这里的意思因该是 Parcels 会保存当前的 CDH 版本信息，保证所下载的所有组件都是符合当前版本。使用 packages 因该是不会考虑当前 CDH 版本的，需要手动维护下载源，否则版本可能会下错。
- **Installation outside of /usr** - 在某些情况下，给 hadoop 集群服务分配的用户角色不一定有权限调用系统的 pacakge 服务去安装包。但是 parcels 可以。
  > 注意：对于 parcels，CDH 的 libraries 目录为：/opt/cloudera/parcels/CDH/lib 而不是 /usr/lib。并且请不要将 /usr/lib 目录与 parcels 的部署目录 link 起来，这会导致一些错误。
- **Installation of CDH without sudo** - 不需要 root 权限也可以安装 CDH 环境
- **Decoupled distribution from activation** - 与实际运行过程解耦，在下载升级前，不会对现有运行的服务造成影响。
- **Rolling upgrades** - 滚动升级，如果使用 packages，意味着你必须要先关闭旧的进程，然后才能进行升级，并且一旦升级出现错误，将很难恢复。使用 parcels 升级，升级将会是循序渐进的，中途无需关闭服务。大版本升级需要重新启动服务。
- **Upgrade Management** - 使用 parcels，Cloudera Manager 可以控制整个升级流程。使用 pacakges，Cloudera Manager 只能触发升级启动
- **Additional component** - parcels 不仅仅适用于 CDH。
- **Compatibility with other distribution tools** - 

### 3.8 Host Management

Cloudera Manager 提供了许多特性用来维护 Hadoop 集群。当你第一次安装 Cloudera Manager 并登陆 Admin Console，你可以搜索当前网络下的 host，然后把它加入到你的 cluster 当中。一旦你选择的 host 被分配了 CDH 服务，Cloudera Manager 会自动帮你去安装所有需要的软件和依赖的包，比如：JDK，Cloudera Manager Agent，Impala，Solr等等

一旦服务被部署成功并开始运转，那么你可以在 Admin Console 查看到 host 的整个运行状态。

### 3.9 Resource Management

资源管理通过定义不同服务对集群资源的影响来帮助确保可预测的行为，主要功能为：

- 针对要求较为苛刻的工作，确保在合理的时间内完成
- 基于每组资源的公平分配，支持在用户组之间进行合理的集群调度
- 防止用户剥夺其他用户访问群集的权限。

主要功能是资源分配，具体内容这里不详细介绍了

### 3.10 User Management

对于 Cloudera Manager 的登陆功能主要由 User Accounts 负责，一个 user account 决定了这个用户的认证，以及所拥有的权限。具体情况这里不做描述了，具体见官方文档。

### 3.11 Security Management

Cloudera Manager 致力于整合多个项目的安全配置，这里也不做过多描述，具体见官方文档。

### 3.12 Cloudera Manager Service

The Cloudera Manager Service 包含了多个组件用来管理整个集群，这些组件被划分为多个角色：

- **Activity Monitor** - 收集有关被 MapReduce 调用的服务信息。默认情况下不会添加该角色
- **Host Monitor** - 收集并衡量有关 host 的健康信息
- **Service Monitor** - 收集并衡量有关 service，yarn 和 impala 启动的服务的健康信息。
- **Event Server** - 收集整理有关 hadoop 事件的信息，使这些信息可以被审计检索。
- **Alert Publisher** - 针对某些事件提供报警功能
- **Reports Manager** - 生成报告，以提供有关用户，用户组和目录的磁盘利用率，用户和YARN池以及HBase表和名称空间处理活动的历史视图。Cloudera Express 中未添加此角色。

#### 3.12.1 Health Test

Cloudera Manager monitor 会监控所有 service，role 的健康状态，并且反馈到 web 页面当中。Cloudera Manager 同时还会提供健康检测，健康检测会将被检测的对象的健康状况分为几个等级。角色健康检测默认为开启状态。一个比较简单的检测例子：检测是否有足够的磁盘空间用于使用

#### 3.12.2 Metric Collection and Display

#### 3.12.3 Events, Alerts, and Triggers


